FROM ubuntu:19.10
ARG ESPIDF_VERSION=v3.3.1
ARG TOOLCHAIN_VERSION=1.22.0-80-g6c4433a-5.2.0
ENV ESPIDF_VERSION ${ESPIDF_VERSION}
ENV TOOLCHAIN_VERSION ${TOOLCHAIN_VERSION}
COPY patches /patches/
RUN apt-get update && \ 
    apt-get install -y --no-install-recommends \
      gcc \
      git \
      make \
      patch \
      wget \
      libncurses-dev \
      flex \
      bison \
      gperf \
      python-pip \
      python-setuptools \
      python-serial \
      python-cryptography \
      python-future \
      python-pyparsing \
      ca-certificates && \
    apt-get autoremove -yqq && \
    apt-get autoclean -yqq && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /var/cache/apt && \ 
    mkdir -p /esp && \
    cd /esp && \ 
    wget https://dl.espressif.com/dl/xtensa-esp32-elf-linux64-$TOOLCHAIN_VERSION.tar.gz && \
    tar -xzf xtensa-esp32-elf-linux64-$TOOLCHAIN_VERSION.tar.gz && \ 
    rm xtensa-esp32-elf-linux64-$TOOLCHAIN_VERSION.tar.gz && \
    git clone --depth 1 --recursive -b $ESPIDF_VERSION https://github.com/espressif/esp-idf.git && \ 
    cd esp-idf && \
    for i in /patches/*.$ESPIDF_VERSION.patch; do patch -p1 < $i; done && \
    cd .. && \
    python -m pip install --user -r /esp/esp-idf/requirements.txt && \
    rm -rf esp-idf/.git && \
    rm -rf /patches
ENV PATH /esp/xtensa-esp32-elf/bin:$PATH
ENV IDF_PATH /esp/esp-idf